# 🔐 AWS Key Management Service (KMS) 

## 📘 What is AWS KMS?

**AWS Key Management Service (KMS)** is a **fully managed encryption and key management service** that enables you to **create, control, and manage cryptographic keys** used to protect your data in AWS.

It allows you to:
- Encrypt data at rest and in transit.
- Manage and rotate encryption keys centrally.
- Integrate seamlessly with other AWS services like S3, EBS, RDS, Lambda, and DynamoDB.

In simple terms:
> AWS KMS helps secure your sensitive information by encrypting it using cryptographic keys that you fully control.

---

## ⚙️ How AWS KMS Works

1. **Create a KMS key** (Customer Master Key / KMS Key).
2. Use the key to **encrypt data** or **generate Data Encryption Keys (DEK)**.
3. KMS **stores and protects** your keys using **Hardware Security Modules (HSMs)**.
4. AWS services or applications use the keys to **encrypt/decrypt data** transparently.

KMS never exposes the key material directly — encryption and decryption happen inside AWS-managed HSMs.

---

## 🧩 Types of KMS Keys

1. **AWS Managed Keys**
   - Created, managed, and used automatically by AWS services.
   - Example: S3 encryption key (`aws/s3`).

2. **Customer Managed Keys (CMKs)**
   - Created and managed by you.
   - You control permissions, key rotation, and lifecycle.

3. **AWS Owned Keys**
   - Fully managed by AWS and shared across accounts.
   - You cannot view or manage them directly.

4. **Customer Managed Key with Imported Key Material**
   - You can import your own encryption key from an on-premise HSM.

---

## 🧠 Key Concepts

### 1. **Customer Master Key (CMK) / KMS Key**
- Logical representation of a key used for encryption/decryption.
- Contains metadata such as key ID, ARN, and creation date.

### 2. **Data Encryption Key (DEK)**
- A **temporary key** generated by KMS to encrypt large datasets.
- Encrypted by the CMK before being stored.

### 3. **Key Policies**
- JSON documents defining **who can use or manage** the key.
- Control both **administrative** and **usage permissions**.

### 4. **Automatic Key Rotation**
- Automatically rotates keys every 365 days (if enabled).
- AWS handles the rotation transparently without re-encrypting data.

### 5. **Envelope Encryption**
A layered approach to encryption:
1. Data is encrypted using a **Data Encryption Key (DEK)**.
2. The DEK itself is encrypted using a **KMS key (CMK)**.
3. When needed, KMS decrypts the DEK, which decrypts the data.

This design provides better performance and security.

---

## 🔗 AWS Services Integrated with KMS

AWS KMS integrates seamlessly with almost all major AWS services:

| AWS Service | Use Case |
|--------------|-----------|
| **Amazon S3** | Encrypt S3 objects using KMS keys. |
| **Amazon EBS** | Encrypt EC2 volumes. |
| **Amazon RDS** | Encrypt database storage and snapshots. |
| **AWS Lambda** | Encrypt environment variables. |
| **Amazon Redshift** | Encrypt data warehouses. |
| **AWS Secrets Manager** | Encrypt secrets and credentials. |
| **AWS CloudTrail** | Encrypt log files. |

---

## 🛡️ AWS KMS Security Features

1. **FIPS 140-2 Level 3 compliant** HSMs.
2. **Granular IAM and Key Policies** for access control.
3. **Automatic Key Rotation** for compliance.
4. **Audit and Monitoring** with CloudTrail.
5. **Separation of Duties** – separate management and usage permissions.
6. **Envelope Encryption** ensures keys never leave KMS unprotected.
7. **Multi-Region Keys** for cross-region encryption management.

---

## 💡 Example: Encrypting and Decrypting Data Using AWS KMS

### 🔧 Scenario:
You want to encrypt sensitive data (like passwords or customer info) using **AWS KMS** before storing it in **Amazon S3**.

---

### 🪜 Step-by-Step:

#### **Step 1: Create a KMS Key**
1. Go to **AWS Management Console → KMS**.
2. Click **Create Key → Symmetric**.
3. Enter alias: `myapp-key`.
4. Define key administrators and usage permissions.
5. Finish key creation.

---

#### **Step 2: Encrypt Data Using AWS CLI**
You can use the AWS CLI to encrypt a plain text file.

Example file: `secret.txt`
```bash
echo "MySecretPassword123" > secret.txt
````

Now encrypt it using your KMS key:

```bash
aws kms encrypt \
  --key-id alias/myapp-key \
  --plaintext fileb://secret.txt \
  --output text \
  --query CiphertextBlob | base64 --decode > secret.txt.encrypted
```

This generates an **encrypted file** that only KMS can decrypt.

---

#### **Step 3: Decrypt Data**

To retrieve the original content:

```bash
aws kms decrypt \
  --ciphertext-blob fileb://secret.txt.encrypted \
  --output text \
  --query Plaintext | base64 --decode
```

Output:

```
MySecretPassword123
```

✅ Data successfully encrypted and decrypted using AWS KMS.

---

## 💰 Pricing

AWS KMS pricing is **based on usage**:

| Component                        | Cost                                  |
| -------------------------------- | ------------------------------------- |
| **Key Creation & Storage**       | $1 per month per Customer Managed Key |
| **API Requests**                 | $0.03 per 10,000 requests             |
| **Automatic Key Rotation**       | Free                                  |
| **AWS Managed Keys**             | No additional cost                    |
| **Cross-region key replication** | Charged per key per month             |

> Example: If you use 5 customer-managed keys and make 100,000 API requests per month →
> Monthly cost ≈ **$5 + $0.30 = $5.30**

---

## 🧱 AWS KMS Best Practices

1. **Use Least Privilege Access** in IAM and key policies.
2. **Enable automatic key rotation** for managed keys.
3. **Separate key administration** and **usage roles**.
4. **Use aliases** for easy key identification.
5. **Monitor all key usage** with **AWS CloudTrail**.
6. **Avoid sharing keys across environments** (e.g., dev, test, prod).
7. **Use envelope encryption** for performance efficiency.
8. **Regularly audit key policies** for compliance.

---

## 🧠 Real-World Example: S3 Bucket Encryption with KMS

### Scenario:

You want all files uploaded to your **S3 bucket** to be encrypted using **your custom KMS key**.

#### Steps:

1. Create a **KMS Key** (alias: `s3-prod-key`).
2. Go to **S3 → Bucket → Properties → Default Encryption**.
3. Choose:

   * Encryption type: **AWS KMS**
   * KMS key: **alias/s3-prod-key**
4. Upload a file to the bucket.

Now all new objects are automatically **encrypted using your KMS key**.

You can verify encryption:

```bash
aws s3api head-object --bucket my-secure-bucket --key myfile.txt
```

Output shows `"ServerSideEncryption": "aws:kms"`.

✅ You have successfully enabled **KMS-based encryption** on your S3 bucket.

---

## ✅ Summary

| Feature              | Description                                       |
| -------------------- | ------------------------------------------------- |
| **Service**          | AWS Key Management Service (KMS)                  |
| **Purpose**          | Centralized encryption key management             |
| **Key Types**        | AWS-managed, Customer-managed, Imported           |
| **Encryption Model** | Envelope encryption                               |
| **Security**         | FIPS 140-2 compliant, integrated with IAM         |
| **Best Practices**   | Least privilege, key rotation, auditing           |
| **Pricing**          | Pay per key and per API request                   |
| **Example**          | Encrypting data or S3 bucket using custom KMS key |

---
